<!DOCTYPE html><html lang="en" > <!-- The Head v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="twitter:image" content="https://microsoftedge.github.io/edgevr/assets/img/edge-logo-128x128.png"><title>Guest Blog Post - Memory corruption vulnerabilities in Edge | Microsoft Browser Vulnerability Research</title><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Guest Blog Post - Memory corruption vulnerabilities in Edge" /><meta name="author" content="David Erceg" /><meta property="og:locale" content="en_US" /><meta name="description" content="Introduction" /><meta property="og:description" content="Introduction" /><link rel="canonical" href="https://microsoftedge.github.io/edgevr/posts/memory-corruption-vulnerabilities-in-edge/" /><meta property="og:url" content="https://microsoftedge.github.io/edgevr/posts/memory-corruption-vulnerabilities-in-edge/" /><meta property="og:site_name" content="Microsoft Browser Vulnerability Research" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-10-17T09:00:00-07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Guest Blog Post - Memory corruption vulnerabilities in Edge" /><meta name="twitter:site" content="@MSEdgeDev" /><meta name="twitter:creator" content="@David Erceg" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"David Erceg"},"description":"Introduction","url":"https://microsoftedge.github.io/edgevr/posts/memory-corruption-vulnerabilities-in-edge/","@type":"BlogPosting","headline":"Guest Blog Post - Memory corruption vulnerabilities in Edge","dateModified":"2022-10-17T09:00:00-07:00","datePublished":"2022-10-17T09:00:00-07:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://microsoftedge.github.io/edgevr/posts/memory-corruption-vulnerabilities-in-edge/"},"@context":"https://schema.org"}</script> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://www.favicon-generator.org/ v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT license --><link rel="shortcut icon" href="/edgevr/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/edgevr/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/edgevr/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/edgevr/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/edgevr/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/edgevr/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/edgevr/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/edgevr/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/edgevr/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/edgevr/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/edgevr/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/edgevr/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/edgevr/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/edgevr/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/edgevr/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/edgevr/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/edgevr/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/edgevr/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/edgevr/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/edgevr/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="preload" as="style" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"> <!-- CSS selector for site. Chirpy v2.3 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT Licensed --><link rel="preload" as="style" href="/edgevr/assets/css/post.css"><link rel="stylesheet" href="/edgevr/assets/css/post.css"><link rel="preload" as="style" href="/edgevr/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/edgevr/assets/css/lib/bootstrap-toc.min.css" /><link rel="preload" as="script" href="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"> <script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" async></script> <script type="text/javascript"> (function(c,l,a,r,i,t,y){ c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)}; t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i; y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y); })(window, document, "clarity", "script", "4xpt5cebre"); </script> <!-- JS selector for site. Chirpy v2.3 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT Licensed --> <script src="/edgevr/assets/js/post.min.js" async></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script> <script src="/edgevr/app.js" defer></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column"> <!-- The Side Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="nav-wrapper"><div id="profile-wrapper" class="d-flex flex-column"><div id="avatar" class="d-flex justify-content-center"> <a href="/edgevr/" alt="avatar"> <img src="/edgevr/assets/img/edge-logo-128x128.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="profile-text mt-3"><div class="site-title"> <a href="/edgevr/">Microsoft Browser <b>Vulnerability Research</b></a></div><div class="site-subtitle font-italic">News from the lab</div></div></div><ul class="nav flex-column"><li class="nav-item d-flex justify-content-center "> <a href="/edgevr/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/edgevr/tabs/categories/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/edgevr/tabs/tags/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a></li><li class="nav-item d-flex justify-content-center "> <a href="/edgevr/tabs/archives/" class="nav-link d-flex justify-content-center align-items-center w-100"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a></li></ul></div><div class="sidebar-bottom d-flex flex-wrap justify-content-around mt-4"> <span id="mode-toggle-wrapper" style="margin-right: 9px;"> <!-- Switch the mode between dark and light. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <i class="mode-toggle fas fa-sun" dark-mode-invisible></i> <i class="mode-toggle fas fa-moon" light-mode-invisible></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.mode != null) { if (this.mode == ModeToggle.DARK_MODE) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.mode != null) { if (self.mode == ModeToggle.DARK_MODE) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightkMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightkMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span> <span class="icon-border" style="display:none;"></span> <a href="https://github.com/MicrosoftEdge" target="_blank"> <i class="fab fa-github-alt"></i> </a> <a href="/edgevr/feed.xml" > <i class="fas fa-rss"></i> </a></div></div><!-- The Top Bar v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/edgevr/"> Posts </a> </span> <span>Guest Blog Post - Memory corruption vulnerabilities in Edge</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Guest Blog Post - Memory corruption vulnerabilities in Edge</h1><div class="post-meta text-muted d-flex flex-column"><div> Posted <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Oct 17, 2022, 9:00 AM -0700" > Oct 17 <i class="unloaded">2022-10-17T09:00:00-07:00</i> </span> by <span class="author"> David Erceg <a href="https://twitter.com/david_erceg" title="Author's Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> </span></div></div><div class="post-content"><h1 id="introduction">Introduction</h1><p>Memory corruption issues in the browser process are typically some of the most severe issues in Chromium and browsers that are based off it. Such issues can include use-after-free (UAF) problems, as well as out-of-bounds (OOB) reads and out-of-bounds writes. This post describes a number of memory corruption issues that I found in Edge, along with some notes about how I found the issues and some of the common patterns between them. I also give an example of how you can investigate and determine the root cause of a UAF in Edge.</p><p>Note that this post assumes the reader has some level of knowledge of both browser internals (e.g. what the browser process is and how it differs from renderer processes) and C++ (e.g. what a <code class="language-plaintext highlighter-rouge">unique_ptr</code> is and how it would be used).</p><div class="inline-response"><h2> <span>Edge Vulnerability Research Team's Response</span></h2><div> Throughout this post you will see these blurbs that explain the approach the team took in handling these reports, how we searched for variants, and our general thoughts on the issues.</div></div><h1 id="uaf-when-selecting-custom-icon-for-web-app">UAF when selecting custom icon for web app</h1><p>In Edge, you can select a custom icon when installing a web app. That is, if you open the app menu and then select <em>Apps</em> &gt; <em>Install this site as an app</em>, the dialog that’s shown allows you to select a custom icon.</p><p align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://microsoftedge.github.io/edgevr/assets/img/blog_img/memory_corruption/web_app_install_dialog.png" alt="Web app install dialog" /></p><p>When you click the “Edit” link shown in the install dialog, a file selection dialog will be shown, from which you can then choose a custom icon.</p><p>In a previous version of Edge, a UAF would occur if the web app install dialog was closed after the file selection dialog was opened, but before a file was selected.</p><p>This issue is a classic lifetime bug. The code that was being run when you selected a file implicitly assumed that the web app install dialog would still exist at that point, but that wouldn’t necessarily be the case. If the tab was navigated elsewhere, the dialog would be closed. The dialog would also be closed if the tab was closed. Either of those things could occur while the file selection dialog was being shown.</p><p>I think this issue is a good example of how lifetime bugs tend to manifest and therefore, what to look for, as a bug hunter. Any sort of asynchronous process introduces some risk of potential lifetime issues. Here, the select file dialog is shown asynchronously (off of the browser’s main UI thread), which means that you can still interact with the browser while it’s being shown. That then allows the install dialog to potentially be closed while the file selection dialog is being shown.</p><p>This issue was rewarded $30,000 USD.</p><h1 id="oob-read-when-capturing-a-read-page">OOB read when capturing a read: page</h1><p>When looking for vulnerabilities in Chromium forks, a good place to look is in functionality that is specific to the fork. Whilst forks can make alterations to existing code, it can be hard to know what’s changed (particularly without source code access), making it easier to find issues in completely new features that have been added.</p><p>The issue here was in such a feature - specifically, in the web capture functionality that Edge offers.</p><p>The issue was that attempting to capture a <code class="language-plaintext highlighter-rouge">read:</code> page would trigger an OOB read in certain cases.</p><p>Edge uses the <code class="language-plaintext highlighter-rouge">read:</code> scheme with its reader mode. If you load a page for which reader mode is available (e.g. <a href="https://techcommunity.microsoft.com/t5/discussions/dev-channel-update-to-95-0-997-1-is-live/m-p/2704057">https://techcommunity.microsoft.com/t5/discussions/dev-channel-update-to-95-0-997-1-is-live/m-p/2704057</a>) and switch to it (using <kbd>F9</kbd>), you’ll see that the <code class="language-plaintext highlighter-rouge">read:</code> scheme is used.</p><p>If you open the DevTools on a reader mode page, you’ll find that the actual page content is contained within an iframe.</p><p>When you then perform a web capture, the code performing the capture has a special case for <code class="language-plaintext highlighter-rouge">read:</code> pages. Specifically, the capture code will capture the contents of the iframe. That’s done by iterating through the frames on the page. In a previous version of Edge, there was no check to see whether the end of the frames vector had been reached.</p><p>Therefore, if you loaded a <code class="language-plaintext highlighter-rouge">read:</code> page that only had a single frame, an OOB read would occur when attempting to capture it.</p><p>An example of a <code class="language-plaintext highlighter-rouge">read:</code> page with a single frame would be an invalid <code class="language-plaintext highlighter-rouge">read:</code> page (e.g. <code class="language-plaintext highlighter-rouge">read://_/?url=</code>), since it’s really just an error page. Another example would be a <code class="language-plaintext highlighter-rouge">view-source:read:…</code> page.</p><p>I found this issue simply by experimenting with the web capture functionality on different types of pages.</p><p>This issue was rewarded $30,000 USD.</p><h1 id="uaf-after-showing-guided-switch-dialog">UAF after showing guided switch dialog</h1><p>This represents another example of looking at a completely new feature in Edge.</p><p>The guided switch dialog is shown when a different profile can be used to login to the target site. For example, if you’re logged into the browser in one profile, but not in a second profile, the guided switch dialog will be shown when loading <code class="language-plaintext highlighter-rouge">https://login.live.com/</code> in the second profile.</p><p align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://microsoftedge.github.io/edgevr/assets/img/blog_img/memory_corruption/guided_switch_dialog.png" alt="Guided switch dialog" /></p><p>The issue here is that the dialog would call <code class="language-plaintext highlighter-rouge">BrowserList::AddObserver</code> on creation, however, if the tab hosting the dialog was moved to another window and the original window was closed, the dialog wouldn’t call <code class="language-plaintext highlighter-rouge">BrowserList::RemoveObserver</code> on destruction.</p><p>Then, if a <code class="language-plaintext highlighter-rouge">BrowserList</code> event was dispatched (e.g. because a browser window was created or closed), a UAF would occur.</p><p>It’s worth mentioning here that <code class="language-plaintext highlighter-rouge">BrowserList::AddObserver</code> should always be matched with a call to <code class="language-plaintext highlighter-rouge">BrowserList::RemoveObserver</code>, so if you find a case where the two aren’t matched, it’s likely problematic. Note that I say likely and not certain here because an object that exists for the lifetime of the browser may call <code class="language-plaintext highlighter-rouge">BrowserList::AddObserver</code> on creation, but never call <code class="language-plaintext highlighter-rouge">BrowserList::RemoveObserver</code>. That wouldn’t be a problem, though, since the object wouldn’t be destroyed until the browser was closed.</p><p>This issue was rewarded $30,000 USD.</p><h1 id="uaf-when-interacting-with-mini-menu">UAF when interacting with mini menu</h1><p>The mini menu shown when selecting some text is another feature that’s specific to Edge.</p><p align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://microsoftedge.github.io/edgevr/assets/img/blog_img/memory_corruption/mini_menu.png" alt="Mini menu" /></p><p>Finding the issue was straightforward. For any browser UI element you might have, there are potential lifetime issues. For example, a dialog might refer to the <code class="language-plaintext highlighter-rouge">WebContents</code> (i.e. tab) it’s opened on and a key question is then whether the dialog can outlive the tab. If it can, that may lead to a UAF. The same sorts of issues apply to menus and bubble views (dialog like elements that are shown in the browser).</p><p>A menu that’s tab-specific that’s not closed when the tab is closed is immediately suspect. Therefore, finding this issue was just a matter of checking whether the menu was closed when the tab was closed. In a previous version of Edge, it wasn’t, which lead to a UAF if one of the menu items was then selected.</p><p>This issue was rewarded $5,000 USD.</p><h1 id="oob-read-in-group-editor-bubble">OOB read in group editor bubble</h1><p>Vertical tabs are another Edge-specific feature. If you turn on vertical tabs in a window, then group a tab, you’ll notice that there’s a three dot button shown in the tab strip. If you click that button, the group editor bubble will be shown.</p><p align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://microsoftedge.github.io/edgevr/assets/img/blog_img/memory_corruption/group_editor_bubble.png" alt="Group editor bubble" /></p><p>Following on from the last issue, an immediate question here is what happens if the group is deleted (by an extension) while the bubble is being shown? In a previous version of Edge, the bubble would continue to be shown, leading to an OOB read when selecting one of the menu items in the bubble.</p><p>This issue is very similar to issue <a href="https://crbug.com/1228557">1228557</a> in the Chromium project.</p><p>This issue was rewarded $30,000 USD.</p><div class="inline-response"><h2> <span>Edge Vulnerability Research Team's Response</span></h2><div><p> In the original report for this issue, David brought up a great point for remediating this bug:</p><blockquote><p> Aside from ensuring that the bubble is destroyed when the group is destroyed, future issues in this area could also be prevented by changing the DHCECK in TabGroupModel::GetTabGroup to a CHECK:</p><p> <a href="https://source.chromium.org/chromium/chromium/src/+/main:chrome/browser/ui/tabs/tab_group_model.cc;l=42;drc=46bbb9795fcc1934c6cfbec096764f888c4d400a" target="_blank" rel="noreferrer">https://source.chromium.org/chromium/chromium/src/+/main:chrome/browser/ui/tabs/tab_group_model.cc;l=42;drc=46bbb9795fcc1934c6cfbec096764f888c4d400a</a></p></blockquote><p> While this wasn't the direction the development team took, mainly to avoid unnecessarily forking of upstream code, it did give the VR team the push to look for other issues that involved the dereferencing of an out of bounds iterator.</p><p> One method the team used to do this was through the amazing tool <a href="https://github.com/googleprojectzero/weggli" target="_blank" rel="noreferrer">weggli</a>.</p><p> For those that are not familiar weggli is a fast semantic search tool built upon the AST parsing library <a href="https://tree-sitter.github.io/tree-sitter/" target="_blank" rel="noreferrer">tree-sitter</a>.</p><p> Weggli offered a very succinct way to express different patterns in the code that could indicate problems. An example of one such query would be the one below.</p><blockquote><p> weggli -X -R find=find -R end=end '{ $x = std::$find(_); NOT: _($x == $end()); NOT: _($x != $end()); _(*$x); }'</p></blockquote><p> The above query looks for code that dereferences the result of a function named <code class="language-plaintext highlighter-rouge">std::*find*</code> without first comparing it to the result of any method containing the string "end". This isn't the only query we explored as there are many other functions that return iterators, and as indicated in David's comment there could be a comparison for <code class="language-plaintext highlighter-rouge">end()</code> but enclosed in a <code class="language-plaintext highlighter-rouge">DCHECK</code>. While writing this post we actually ran this query again and found a fixed upstream issue in Edge that failed to merge into our forked code!</p><p> When using weggli, similar to other tools such as CodeQL, we aren't looking for a silver-bullet that only identifies vulnerabilities, but simply want to find starting points for research and verification.</p></div></div><h1 id="oob-read-when-dragging-link-over-tab-strip">OOB read when dragging link over tab strip</h1><p>This issue is interesting, in that it’s essentially the same as issue <a href="https://crbug.com/1209616">1209616</a> in the Chromium project. That is, when a window is closed, there’s a brief period where the window still exists, but contains no tabs. In a previous version of Edge, an OOB read could occur if a link was being dragged over the tab strip at that time.</p><p>The Chromium issue was fixed by updating <code class="language-plaintext highlighter-rouge">TabStrip::GetDropBounds</code> to check whether the tab strip is empty. In Edge, the <code class="language-plaintext highlighter-rouge">EdgeTabStrip</code> class inherits from <code class="language-plaintext highlighter-rouge">TabStrip</code> and <code class="language-plaintext highlighter-rouge">EdgeTabStrip::GetDropBounds</code> overrides <code class="language-plaintext highlighter-rouge">TabStrip::GetDropBounds</code>. That means that although the issue was fixed in Chromium, the issue remained present in Edge.</p><p>This demonstrates how it can be worthwhile to check whether issues that have been fixed in Chromium still reproduce in Edge. I think it’s also an illustration of how changing the core Chromium code (whether directly or indirectly) in a fork can mean that security fixes in the Chromium project don’t have the intended effect in the forked project.</p><p>This issue was rewarded $30,000 USD.</p><h1 id="uaf-when-closing-web-app-install-dialog">UAF when closing web app install dialog</h1><p>As described in the first issue above, the web app install dialog allows a custom icon to be chosen. One thing I noticed when selecting a custom icon file is that there’s a bit of delay between selecting the file and having the preview be shown in the dialog. A natural question then is what happens if the dialog is closed before the icon preview is updated (i.e. immediately after a file is selected)?</p><p>In a previous version of Edge, a UAF would occur, due to the fact that the object that was processing the image on a background thread would be destroyed (in the middle of the processing operation) when the dialog was closed.</p><p>This again illustrates how an asynchronous process can lead to lifetime issues.</p><p>This issue was rewarded $30,000 USD.</p><div class="inline-response"><h2> <span>Edge Vulnerability Research Team's Response</span></h2><div><p> Here David has honed in on a very common bug pattern that we have spent a lot of effort in education and tooling to try to combat. Internally, UAFs stemming from a mismatch of object lifetimes and threads using those objects account for a large number of the findings by the security team.</p><p> For this particular issue, the code that caused it looks very similar to the below example code.</p><div class="language-c++ highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
      2
      3
      4
      5
      6
      7
      8
      9
      </pre><td class="rouge-code"><pre><span class="n">base</span><span class="o">::</span><span class="n">ThreadPool</span><span class="o">::</span><span class="n">PostTaskAndReply</span><span class="p">(</span>
         <span class="n">FROM_HERE</span><span class="p">,</span>
         <span class="p">{</span><span class="n">base</span><span class="o">::</span><span class="n">MayBlock</span><span class="p">(),</span> <span class="n">base</span><span class="o">::</span><span class="n">TaskPriority</span><span class="o">::</span><span class="n">BEST_EFFORT</span><span class="p">,</span>
            <span class="n">base</span><span class="o">::</span><span class="n">TaskShutdownBehavior</span><span class="o">::</span><span class="n">SKIP_ON_SHUTDOWN</span><span class="p">},</span>
         <span class="n">base</span><span class="o">::</span><span class="n">BindOnce</span><span class="p">(</span>
               <span class="n">base</span><span class="o">::</span><span class="n">IgnoreResult</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MyClass</span><span class="o">::</span><span class="n">Method</span><span class="p">),</span>
               <span class="n">base</span><span class="o">::</span><span class="n">Unretained</span><span class="p">(</span><span class="k">this</span><span class="p">),</span> <span class="n">parameter</span><span class="p">),</span>
         <span class="n">base</span><span class="o">::</span><span class="n">BindOnce</span><span class="p">(</span><span class="o">&amp;</span><span class="n">MyClass</span><span class="o">::</span><span class="n">Callback</span><span class="p">,</span>
                        <span class="n">weak_ptr_factory_</span><span class="p">.</span><span class="n">GetWeakPtr</span><span class="p">()));</span>
      </pre></table></code></div></div><p> In the above code, you can see that a task executing <code class="language-plaintext highlighter-rouge">MyClass::Method</code> is scheduled to run on a background thread. When <code class="language-plaintext highlighter-rouge">MyClass::Method</code> completes, <code class="language-plaintext highlighter-rouge">MyClass::Callback</code> will be scheduled to execute on the sequence that originally called <code class="language-plaintext highlighter-rouge">PostTaskAndReply</code>. The <code class="language-plaintext highlighter-rouge">this</code> value for <code class="language-plaintext highlighter-rouge">MyClass</code> is bound as a parameter so that when <code class="language-plaintext highlighter-rouge">MyClass::Method</code> executes it uses the instance of <code class="language-plaintext highlighter-rouge">MyClass</code>. The <code class="language-plaintext highlighter-rouge">base::Unretained</code> indicates <code class="language-plaintext highlighter-rouge">this</code> will be a raw pointer and will not be reference counted. Unlike the call to <code class="language-plaintext highlighter-rouge">MyClass::Method</code>, the first parameter of <code class="language-plaintext highlighter-rouge">MyClass::Callback</code> is instead a weak pointer. This difference causes Edge to check if the instance of <code class="language-plaintext highlighter-rouge">MyClass</code> is still alive before it attempts to execute <code class="language-plaintext highlighter-rouge">Callback</code>. If <code class="language-plaintext highlighter-rouge">MyClass</code> is destroyed on the same sequence that <code class="language-plaintext highlighter-rouge">MyClass::Callback</code> is scheduled, then we can be sure that when <code class="language-plaintext highlighter-rouge">MyClass::Callback</code> begins executing the object is still alive and will remain alive for the entire time it is running.</p><p> In this case the bug, was exactly as David mentioned. The instance of <code class="language-plaintext highlighter-rouge">MyClass</code> could be destroyed while running in this background thread. Many times we have seen developers believe a fix to issues like this is to convert the <code class="language-plaintext highlighter-rouge">base::Unretained(this)</code> into a <code class="language-plaintext highlighter-rouge">weak_ptr_factory_.GetWeakPtr()</code> call. However, this is incorrect as that would only prevent the task from being run if the object was not already destroyed. This means as soon as the task is running all bets are off and there will be a race.</p><p> Luckily, these types of issues are fairly easy to audit for statically and dynamically. I will list them from least complex to most complex.</p><h3>Grep</h3><p> KISS, keep it simple stupid, can be a good way to approach problems like these. Just having a dashboard with all newly added <code class="language-plaintext highlighter-rouge">PostTask</code> calls is surprisingly a viable technique for identifying these types of problems on commit. The cognitive load with this technique is fairly high, but it usually only takes a couple seconds to verify if a <code class="language-plaintext highlighter-rouge">PostTask</code> call could lead to a problem. It's a nice ritual to add while having my coffee in the morning. A downside to this is it really only helps audit new code and not identifying code already in the code base. It is also rather fragile to a person changing the parameters of an already existing <code class="language-plaintext highlighter-rouge">PostTask</code> call.</p><h3>Clang AST Matchers</h3><p> Despite the heading of the <a href="https://chromium.googlesource.com/chromium/src.git/+/refs/heads/main/docs/writing_clang_plugins.md" target="_blank" rel="noreferrer">chromium documentation</a> for writing clang plugins being <b>"Don't write a clang plugin"</b>, they can be rather useful. In the above example, the core issue is passing a reference to <code class="language-plaintext highlighter-rouge">this</code> for use on another thread. While it can be tricky to identify the <code class="language-plaintext highlighter-rouge">PostTask</code> call itself, identifying these unsafe binds is trivial with a <a href="https://firefox-source-docs.mozilla.org/code-quality/static-analysis/writing-new/index.html" target="_blank" rel="noreferrer">matcher plugin</a>. With this technique, we can accurately identify <code class="language-plaintext highlighter-rouge">base::BindOnce</code> and <code class="language-plaintext highlighter-rouge">base::BindRepeating</code> calls that store pointers or even weak pointers to these unsafe types and use them to target code review. One benefit to this technique is it can be quite fast as it is trivial to run on only files that have been recently changed.</p><h3>CodeQL</h3><p> Similar to the previous technique, another method of identifying these unsafe threading calls is targeting the <code class="language-plaintext highlighter-rouge">base::Bind*</code> calls with CodeQL. However, unlike when using a matcher you can use CodeQL to find sinks where the closure created by the bind is used. The folks at GitHub have created an amazing pack of <a href="https://github.com/github/securitylab/blob/main/CodeQL_Queries/cpp/Chrome/README.md" target="_blank" rel="noreferrer">CodeQL scripts</a> that can be used out of the box or as a starting point.</p><h3>Instrumentation</h3><p> This technique is potentially more complex, but depending on how you implement it can be applied at build-time or at runtime. The idea behind this technique would be pinning memory access for certain object types to specific threads. For example, it is nearly <b>ALWAYS</b> a UAF if a pointer to a <code class="language-plaintext highlighter-rouge">WebContents</code> object and many other object types to be dereferenced from any thread but the UI thread. With this in mind, we can use use Clang or hooking at runtime to instrument memory accesses to these classes of objects and alert us of potential issues.</p></div></div><h1 id="uaf-when-closing-javascript-dialog">UAF when closing JavaScript dialog</h1><p>In a previous version of Edge, <kbd>F6</kbd> would cycle focus not just between core UI elements in the browser window (e.g. the tab strip and address bar), but also any JavaScript dialog. That is, <kbd>F6</kbd> could also shift focus to the dialog itself.</p><p>Internally, to support this, the dialog would call <code class="language-plaintext highlighter-rouge">BrowserView::SetFocusDialog</code> on creation and <code class="language-plaintext highlighter-rouge">BrowserView::RemoveFocusDialog</code> on destruction.</p><p>However, if the dialog was moved to another browser window, the original window closed, and the dialog then closed, the call to <code class="language-plaintext highlighter-rouge">BrowserView::RemoveFocusDialog</code> would trigger a UAF, as it would attempt to make a call on the original <code class="language-plaintext highlighter-rouge">BrowserView</code>.</p><p>I think this illustrates how dialogs can be a good place to look for vulnerabilities. There are essentially two types of dialogs:</p><ul><li>Browser modal dialogs. These dialogs are tied to a browser window.</li><li>Tab modal dialogs. These dialogs are tied to a tab.</li></ul><p>This creates a few places for potential security issues:</p><ul><li>A browser modal dialog that refers to a particular <code class="language-plaintext highlighter-rouge">WebContents</code> (i.e. tab) is likely wrong, since the tab can be closed without closing the dialog.</li><li>A tab modal dialog that refers to a particular <code class="language-plaintext highlighter-rouge">Browser</code> instance (or anything associated with that <code class="language-plaintext highlighter-rouge">Browser</code>, such as the <code class="language-plaintext highlighter-rouge">BrowserView</code>) is likely wrong, since the tab and dialog can be moved to another browser window and the original browser window closed.</li><li>Any dialog that refers to data that an extension/web page can modify or delete is problematic, precisely because the extension/web page can modify data while the dialog is being shown. An example of this can be seen in issue <a href="https://crbug.com/1161144">1161144</a> in the Chromium project.</li></ul><p>This issue was rewarded $30,000 USD.</p><h1 id="verifying-a-memory-corruption-issue-in-edge">Verifying a memory corruption issue in Edge</h1><p>With each of the issues above, I typically observed a browser crash after performing a series of steps. A question that immediately comes up after observing such a crash is whether the crash is due to a memory corruption issue.</p><p>While a crash that refers to a valid-looking memory address is a dead giveaway that a memory corruption issue is involved, that’s not always what happens. I’ve encountered quite a few UAFs, for example, that tend to crash the browser with a reference to a near-NULL address. There’s then a need to distinguish between a memory corruption issue and a harmless NULL pointer dereference.</p><p>When verifying a potential memory corruption issue in Chromium, the problem is often trivial. There are AddressSanitizer (ASan) builds <a href="https://chromium.googlesource.com/chromium/src/+/HEAD/docs/asan.md#pre_built-chrome-binaries">available</a> for Chromium. Typically, all you need to do is download one of those builds, reproduce the issue in it, and check the output that it gives you.</p><p>However, there are no ASan builds available for Edge. Verifying that a crash in Edge is being caused by an exploitable memory issue is possible, but more work then when you have an ASan build available.</p><p>There are different ways of going about the process of verifying the cause of a crash, but I rely on two specific tools, along with the debugging symbols that Microsoft provide:</p><ol><li><p><a href="https://ghidra-sre.org/">Ghidra</a></p></li><li><p><a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/debugger-download-tools">WinDbg</a></p></li></ol><p>Ghidra allows the binary code that comprises the browser to be decompiled and turned back into an approximate version of the original code.</p><p>WinDbg lets you debug the browser as it’s running.</p><p>Taken together, these two tools make it reasonably easy to step through the code as it’s running and gain a high-level understanding of what’s happening.</p><p>What follows here is an illustration of how you can use these tools to investigate a potential security issue, with the first UAF described above used as an example.</p><h2 id="ghidra-setup">Ghidra setup</h2><ol><li><a href="https://github.com/NationalSecurityAgency/ghidra/releases">Download Ghidra</a>.</li><li>In Ghidra, create a new project and import msedge.dll (found in C:\Program Files (x86)\Microsoft\Edge\Application\{version}).</li><li>Open msedge.dll in the CodeBrowser tool. When asked if you would like to analyze msedge.dll, select “No”.</li><li>Load the PDB for msedge.dll, by selecting <em>File</em> &gt; <em>Load PDB File…</em> Ensure that you have a local symbol storage path configured and that you’ve added the Microsoft symbol server (<code class="language-plaintext highlighter-rouge">https://msdl.microsoft.com/download/symbols</code>) as a search path.</li><li>Once you’ve loaded the PDB file, Ghidra will process it, before performing an auto analysis of msedge.dll. Expect this process to take a while - at least several hours. Once the auto analysis has finished, you can then browse through the decompiled code generated from msedge.dll.</li></ol><h2 id="windbg-setup">WinDbg setup</h2><p>There’s not much setup required for WinDbg. Ensure that you have the Microsoft symbol server included in the symbol server settings and then attach WinDbg to the Edge browser process.</p><h2 id="investigating-an-issue---an-example">Investigating an issue - an example</h2><p>Once you have Ghidra and WinDbg set up, you can then investigate an issue.</p><p>Below is a demonstration of how I investigated the first issue described above. Note that the investigation is based on an older version of msedge.dll and its corresponding symbol file. As Microsoft only provide symbols for the current version of msedge.dll, you won’t be able to reproduce the demonstration here exactly, but the process of investigating an issue is what’s important (since it doesn’t tend to change much from one issue to another).</p><p>Having observed a crash when selecting a custom icon file, the first thing to do is to examine the crash dump. Doing so gives the following stack trace (only the last few relevant entries are shown):</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>msedge.dll!WebAppCustomIconFile::~WebAppCustomIconFile()
msedge.dll!EdgeWebAppCustomIcon::OnEditIconButtonPressed()
msedge.dll!base::internal::Invoker&lt;base::internal::BindState&lt;`lambda at ../../ui/views/controls/button/button.cc:115:31',base::RepeatingCallback&lt;void ()&gt;&gt;,void (const ui::Event &amp;)&gt;::Run()
msedge.dll!views::Link::OnMouseReleased(class ui::MouseEvent const &amp;)
...
</pre></table></code></div></div><p>As can be seen, the crash occurred within <code class="language-plaintext highlighter-rouge">EdgeWebAppCustomIcon::OnEditIconButtonPressed</code>. Often (though not always), the crash dump will give a starting point for any investigation.</p><p>The next logical step is to look at the <code class="language-plaintext highlighter-rouge">EdgeWebAppCustomIcon</code> class in Ghidra.</p><p align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://microsoftedge.github.io/edgevr/assets/img/blog_img/memory_corruption/EdgeWebAppCustomIcon_constructor.png" alt="EdgeWebAppCustomIcon constructor" /></p><p align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://microsoftedge.github.io/edgevr/assets/img/blog_img/memory_corruption/EdgeWebAppCustomIcon_OnEditIconButtonPressed.png" alt="EdgeWebAppCustomIcon::OnEditIconButtonPressed" /></p><p align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://microsoftedge.github.io/edgevr/assets/img/blog_img/memory_corruption/EdgeWebAppCustomIcon_destructor.png" alt="EdgeWebAppCustomIcon destructor" /></p><p>As can be seen in the screenshots above, <code class="language-plaintext highlighter-rouge">EdgeWebAppCustomIcon</code> holds an instance of <code class="language-plaintext highlighter-rouge">WebAppCustomIconFile</code> in a member variable (likely as a <code class="language-plaintext highlighter-rouge">unique_ptr</code>).</p><ul><li>The value is initialized to <code class="language-plaintext highlighter-rouge">NULL</code> in the constructor.</li><li>The instance member is set in <code class="language-plaintext highlighter-rouge">EdgeWebAppCustomIcon::OnEditIconButtonPressed</code> and any previous instance is destroyed.</li><li>The instance is also destroyed (when appropriate) in the destructor.</li></ul><p>Based on that, it appears that the <code class="language-plaintext highlighter-rouge">EdgeWebAppCustomIcon</code> class has ownership of the <code class="language-plaintext highlighter-rouge">WebAppCustomIconFile</code> instance and is responsible for managing its lifetime. Therefore, if the <code class="language-plaintext highlighter-rouge">WebAppCustomIconFile</code> instance being destroyed isn’t valid, the <code class="language-plaintext highlighter-rouge">EdgeWebAppCustomIcon</code> instance likely isn’t either.</p><p>The next step is to check how the <code class="language-plaintext highlighter-rouge">EdgeWebAppCustomIcon</code> instance is created and how it’s destroyed. While Ghidra can be used to for that purpose (e.g. by searching for references to <code class="language-plaintext highlighter-rouge">EdgeWebAppCustomIcon::EdgeWebAppCustomIcon</code> and <code class="language-plaintext highlighter-rouge">EdgeWebAppCustomIcon::~EdgeWebAppCustomIcon</code>), I think WinDbg tends to be the better option here, since there can be multiple callers, or the caller may not be shown by Ghidra (depending on exactly how the call is made).</p><p>When attached to the browser in WinDbg, the following command can be used to set a breakpoint on the <code class="language-plaintext highlighter-rouge">EdgeWebAppCustomIcon</code> constructor:</p><p><code class="language-plaintext highlighter-rouge">bu msedge!EdgeWebAppCustomIcon::EdgeWebAppCustomIcon</code></p><p>Similarly, the command below can be used to set a breakpoint on the <code class="language-plaintext highlighter-rouge">EdgeWebAppCustomIcon</code> destructor:</p><p><code class="language-plaintext highlighter-rouge">bu msedge!EdgeWebAppCustomIcon::~EdgeWebAppCustomIcon</code></p><p>Running the browser with these breakpoints set then shows that the <code class="language-plaintext highlighter-rouge">EdgeWebAppCustomIcon</code> instance is being created in the following way:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>msedge!EdgeWebAppCustomIcon::EdgeWebAppCustomIcon
msedge!WebAppConfirmationView::WebAppConfirmationView
msedge!chrome::EdgeShowSiteDialog
...
</pre></table></code></div></div><p>While it’s being destroyed in the following way:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>msedge!EdgeWebAppCustomIcon::~EdgeWebAppCustomIcon
msedge!WebAppConfirmationView::~WebAppConfirmationView
msedge!WebAppConfirmationView::`scalar deleting destructor'
msedge!views::WidgetDelegate::DeleteDelegate
msedge!views::Widget::OnNativeWidgetDestroyed
msedge!views::NativeWidgetAura::OnWindowDestroyed
...
</pre></table></code></div></div><p>Looking at the <code class="language-plaintext highlighter-rouge">WebAppConfirmationView</code> class in Ghidra shows that the <code class="language-plaintext highlighter-rouge">EdgeWebAppCustomIcon</code> instance is being stored in a member variable (again, likely as a <code class="language-plaintext highlighter-rouge">unique_ptr</code>).</p><p align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://microsoftedge.github.io/edgevr/assets/img/blog_img/memory_corruption/WebAppConfirmationView_constructor.png" alt="WebAppConfirmationView constructor" /></p><p align="center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://microsoftedge.github.io/edgevr/assets/img/blog_img/memory_corruption/WebAppConfirmationView_destructor.png" alt="WebAppConfirmationView destructor" /></p><p>To summarize:</p><ul><li><code class="language-plaintext highlighter-rouge">WebAppConfirmationView</code> is the view associated with the web app install dialog.</li><li><code class="language-plaintext highlighter-rouge">WebAppConfirmationView</code> holds an instance of <code class="language-plaintext highlighter-rouge">EdgeWebAppCustomIcon</code> in a member variable. When <code class="language-plaintext highlighter-rouge">WebAppConfirmationView</code> is destroyed, <code class="language-plaintext highlighter-rouge">EdgeWebAppCustomIcon</code> is destroyed as well.</li><li><code class="language-plaintext highlighter-rouge">WebAppConfirmationView</code> is destroyed when the web app install dialog is closed. That can happen when the tab is navigated elsewhere or closed.</li></ul><p>Therefore, in the original scenario given above, the following occurs:</p><ol><li>The user opens the web app install dialog on a tab. An instance of the <code class="language-plaintext highlighter-rouge">WebAppConfirmationView</code> class is created, which then creates an instance of <code class="language-plaintext highlighter-rouge">EdgeWebAppCustomIcon</code> and stores it in a member variable.</li><li>The user then clicks the “Edit” link in the install dialog, which results in a file selection dialog being shown.</li><li>The tab is then navigated to a different location or closed (by the page itself or by an extension). This results in the dialog being closed and both the <code class="language-plaintext highlighter-rouge">WebAppConfirmationView</code> and <code class="language-plaintext highlighter-rouge">EdgeWebAppCustomIcon</code> instances being destroyed.</li><li>The user chooses a file from the file selection dialog, which causes <code class="language-plaintext highlighter-rouge">EdgeWebAppCustomIcon::OnEditIconButtonPressed</code> to access members of the class. However, the <code class="language-plaintext highlighter-rouge">EdgeWebAppCustomIcon</code> instance has already been destroyed, so that results in a UAF.</li></ol><p>As a side note, when verifying a UAF, it can also be useful to see that the memory being accessed was the memory that was freed. WinDbg allows you to place data breakpoints, which can be used for that purpose.</p><p>For example, in the case above, you might observe the creation of the <code class="language-plaintext highlighter-rouge">EdgeWebAppCustomIcon</code> instance and place a data breakpoint on its address (the command below assumes that the address is <code class="language-plaintext highlighter-rouge">4fe400c5bf00</code>):</p><p><code class="language-plaintext highlighter-rouge">ba w8 4fe400c5bf00</code></p><p>That breakpoint should then be hit when the instance is freed. You can then verify that <code class="language-plaintext highlighter-rouge">EdgeWebAppCustomIcon::OnEditIconButtonPressed</code> is trying to access memory within that block.</p><p>Another very useful feature offered by WinDbg preview is <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/debugger/time-travel-debugging-overview">time travel debugging</a>. I mentioned above that a crash dump may not always give you much information. Because a crash dump only gives you information about where the crash occurred, it’s not necessarily helpful when figuring out the cause of a crash.</p><p>For example, if there’s an object that’s used from many different places and can be allocated in various ways, a UAF involving that object might cause a crash in a variety of locations (depending on whatever happens to try to access the object first). A crash dump won’t be terribly useful in that sort of situation, since although it will probably show what object is involved, it won’t show where it was allocated.</p><p>Time travel debugging coupled with data breakpoints can be a very powerful tool in debugging those sorts of crashes. Although I didn’t need time travel debugging for any of the issues listed here, I did use it to investigate some more recent issues and it was essential in those cases. So, if you’re using WinDbg to investigate an issue you’ve found, it’s something to keep in mind.</p><h1 id="conclusion">Conclusion</h1><p>As demonstrated by the issues described above, there are a few patterns that can be used to find vulnerabilities. Any asynchronous process introduces the possibility of lifetime issues. Doing same basic tests of such a process (e.g. testing what happens when you close a tab/window/the browser while the process is ongoing) can reveal issues.</p><p>Dialogs also present a good opportunity to find lifetime issues, given that the lifetime of a dialog may be independent of the lifetime of the resources that it references.</p><p>Looking for issues in functionality that has specifically been added to Edge can also be a good step to take. You can find such functionality by experimenting within the browser, reading through the documentation for Edge, browsing through the decompiled code in Ghidra, or by looking through the information Microsoft publishes for <a href="https://www.microsoftedgeinsider.com/en-us/whats-new">what’s new</a> in the browser.</p><p>In terms of investigating and determining the root cause of an issue when the source code isn’t available, Ghidra and WinDbg are invaluable. Whilst I only described the process of investigating the first issue above, I used both Ghidra and WinDbg to investigate each of the issues here.</p><p>Although it can be time consuming to determine the cause of an issue, it’s helpful both because it means the browser developers don’t have to spend too much time investigating and because knowing how the browser works, in specific detail, can make it significantly easier to find further issues.</p><p>In total, the issues described here were rewarded $215,000 USD by Microsoft, illustrating how valuable it can be to find and report memory corruption issues to the browser vendors.</p><div class="inline-response"><h2> <span>Edge Vulnerability Research Team's Response</span></h2><div><p> The Edge Vulnerability Research Team owns the triage process for all MSRC cases involving Microsoft Edge, and we strive to make quick and fair assessments on the impact of vulnerabilities and adequately compensate researchers that take the time to hunt for bugs. On the topic of compensation, it is worth noting that the Edge team aligns itself very closely with the severity guidelines of Chromium and due to recent changes in the <a href="https://chromium.googlesource.com/chromium/src/+/HEAD/docs/security/severity-guidelines.md" target="_blank" rel="noreferrer">upstream policy</a>, in regards to user interaction, some of these issues if reported today may not be paid out at the same amount.</p><p> In closing, the security team greatly appreciates David's reports, and with David sharing some of his processes, we hope we get even more external reports and can continue to keep our users secure.</p></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/edgevr/categories/vulnerabilities/'>Vulnerabilities</a>, <a href='/edgevr/categories/exploit/'>Exploit</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/edgevr/tags/memory-corruption/" class="post-tag no-text-decoration" >Memory Corruption</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><!-- Post sharing snippet v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Guest Blog Post - Memory corruption vulnerabilities in Edge - Microsoft Browser Vulnerability Research&url=https://microsoftedge.github.io/edgevr/posts/memory-corruption-vulnerabilities-in-edge/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Guest Blog Post - Memory corruption vulnerabilities in Edge - Microsoft Browser Vulnerability Research&u=https://microsoftedge.github.io/edgevr/posts/memory-corruption-vulnerabilities-in-edge/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Guest Blog Post - Memory corruption vulnerabilities in Edge - Microsoft Browser Vulnerability Research&url=https://microsoftedge.github.io/edgevr/posts/memory-corruption-vulnerabilities-in-edge/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://microsoftedge.github.io/edgevr/posts/memory-corruption-vulnerabilities-in-edge/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank"> <i class="fa-fw fab fa-linkedin"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><!-- The Pannel on right side (Desktop views) v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><h3 data-toc-skip>Recent Update</h3><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/edgevr/posts/Introducing-Enhanced-Security-for-Microsoft-Edge/">Introducing Enhanced Security for Microsoft Edge</a></li><li><a href="/edgevr/posts/Super-Duper-Secure-Mode/">Super Duper Secure Mode</a></li><li><a href="/edgevr/posts/attacking-the-devtools/">Guest Blog Post - Attacking the DevTools</a></li><li><a href="/edgevr/posts/eliminating-xss-with-trusted-types/">Eliminating XSS from WebUI with Trusted Types</a></li><li><a href="/edgevr/posts/Hacking-Chrome-iOS/">iOS Chromium Overlooked and Underappreciated</a></li></ul></div><div id="access-tags"><h3 data-toc-skip>Trending Tags</h3><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/edgevr/tags/tips/">tips</a> <a class="post-tag" href="/edgevr/tags/site-isolation/">Site Isolation</a> <a class="post-tag" href="/edgevr/tags/jit/">JIT</a> <a class="post-tag" href="/edgevr/tags/ios/">iOS</a> <a class="post-tag" href="/edgevr/tags/fuzzing/">fuzzing</a> <a class="post-tag" href="/edgevr/tags/ui/">UI</a> <a class="post-tag" href="/edgevr/tags/trusted-types/">Trusted Types</a> <a class="post-tag" href="/edgevr/tags/memory-corruption/">Memory Corruption</a> <a class="post-tag" href="/edgevr/tags/headlines/">Headlines</a> <a class="post-tag" href="/edgevr/tags/devtools/">DevTools</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h3 data-toc-skip class="pl-3 pt-2 mb-2">Contents</h3><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <!-- Recommend the other 3 posts according to the tags and categories of the current post, if the number is not enough, use the other latest posts to supplement. v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2019 Cotes Chung Published under the MIT License --><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/edgevr/posts/yet-another-uaf/"><div class="card-body"> <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago small" > Mar 2, 2021 <i class="unloaded">2021-03-02T08:00:00-08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Yet another RenderFrameHostImpl UAF</h3><div class="text-muted small"><p> Introduction Back in 2020 while reviewing Chromium code, I found issue 1068395, a Use-After-Free in Browser Process that can be used to escape the Chromium sandbox on Android Devices. This is an i...</p></div></div></a></div><div class="card"> <a href="/edgevr/posts/attacking-the-devtools/"><div class="card-body"> <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago small" > Jul 21, 2021 <i class="unloaded">2021-07-21T09:00:00-07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Guest Blog Post - Attacking the DevTools</h3><div class="text-muted small"><p> In this post, we’ve invited David Erceg, one of the participants in the Edge bug bounty program, to talk about interesting bugs he found in Edge. By sharing this information, we hope more security...</p></div></div></a></div><div class="card"> <a href="/edgevr/posts/Hacking-Chrome-iOS/"><div class="card-body"> <!-- Date format snippet v2.4.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --> <span class="timeago small" > Oct 16, 2020 <i class="unloaded">2020-10-16T09:00:00-07:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>iOS Chromium Overlooked and Underappreciated</h3><div class="text-muted small"><p> A Bold New Frontier As part of Microsoft’s Edge’s move to using Chromium as the backbone of our browsers, we are updating all our browser product lines, including the iOS version. As security engin...</p></div></div></a></div></div></div><!-- Navigation buttons at the bottom of the post. v2.1 https://github.com/cotes2020/jekyll-theme-chirpy © 2020 Cotes Chung MIT License --><div class="post-navigation d-flex justify-content-between"> <a href="/edgevr/posts/a-story-of-a-bug-found-fuzzing/" class="btn btn-outline-primary"><p>A Story of a Bug Found Fuzzing</p></a> <span class="btn btn-outline-primary disabled"><p>-</p></span></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('#post-wrapper img'); const observer = lozad(imgs); observer.observe(); </script> <!-- The Footer v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/MSEdgeDev">Microsoft Corporation</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/">Chirpy</a> theme.</p></div></div></footer></div><!-- The Search results v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/edgevr/tags/tips/">tips</a> <a class="post-tag" href="/edgevr/tags/site-isolation/">Site Isolation</a> <a class="post-tag" href="/edgevr/tags/jit/">JIT</a> <a class="post-tag" href="/edgevr/tags/ios/">iOS</a> <a class="post-tag" href="/edgevr/tags/fuzzing/">fuzzing</a> <a class="post-tag" href="/edgevr/tags/ui/">UI</a> <a class="post-tag" href="/edgevr/tags/trusted-types/">Trusted Types</a> <a class="post-tag" href="/edgevr/tags/memory-corruption/">Memory Corruption</a> <a class="post-tag" href="/edgevr/tags/headlines/">Headlines</a> <a class="post-tag" href="/edgevr/tags/devtools/">DevTools</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <!-- The GA snippet v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', '', 'auto'); ga('send', 'pageview'); </script> <!-- Jekyll Simple Search loader v2.0 https://github.com/cotes2020/jekyll-theme-chirpy © 2017-2019 Cotes Chung MIT License --> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/edgevr/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://microsoftedge.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
